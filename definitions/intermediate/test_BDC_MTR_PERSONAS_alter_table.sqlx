/*
 * Pre-Output Dataform Operation
 * 
 * This function ensures the output table schema matches the source table schema before data output is generated.
 * It checks if the source table has more columns than the output table and, if so, adds the missing columns to the output table.
 *
 * This operation is necessary because Dataform predetermines the table schema before the script execution. If this function were defined 
 * inside the output file, any schema alterations made within the script would not be reflected during the INSERT INTO operation. 
 * Therefore, it's essential to handle this schema alignment in a separate, intermediate file.
 */
config {
  type: "operations"
}
DECLARE table_name STRING DEFAULT 'test_BDC_MTR_PERSONAS';

DECLARE source_column_count INT64;
DECLARE output_column_count INT64;

-- It will only be executed if the output table exists.
IF (SELECT IF(COUNT(1) = 1, true, false)
    FROM askasks-poc-master.ds_poc_oracle.INFORMATION_SCHEMA.TABLES
    WHERE table_name = table_name) THEN

  -- Get the number of columns in the source table
  SET source_column_count = (
    SELECT COUNT(column_name)
    FROM askasks-poc-raw.ds_poc_oracle.INFORMATION_SCHEMA.COLUMNS
    WHERE table_name = table_name
  );

  -- Get the number of columns in the output table
  SET output_column_count = (
    SELECT COUNT(column_name)
    FROM askasks-poc-master.ds_poc_oracle.INFORMATION_SCHEMA.COLUMNS
    WHERE table_name = table_name
  );

  -- If the source table has more columns than the output table, add the missing columns
  IF source_column_count != output_column_count THEN
    FOR row IN (
      SELECT column_name, data_type
      FROM (
        SELECT column_name, data_type
        FROM askasks-poc-raw.ds_poc_oracle.INFORMATION_SCHEMA.COLUMNS
        WHERE table_name = table_name
          AND column_name NOT IN (
            SELECT column_name
            FROM askasks-poc-master.ds_poc_oracle.INFORMATION_SCHEMA.COLUMNS
            WHERE table_name = table_name
          )
      )
    ) DO
      -- Add the missing columns to the output table
      EXECUTE IMMEDIATE FORMAT("""
        ALTER TABLE askasks-poc-master.ds_poc_oracle.%s
        ADD COLUMN %s %s
      """, table_name, row.column_name, row.data_type);
    END FOR;
  END IF;
END IF;
